<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <template id="timesheet_report">
        <t t-call="web.html_container">
          <t t-call="web.internal_layout">
                    <div class="page">
                    <div  style="position: relative; max-width: 400px;">
                           <table>
                            <tr >
                                <th style="border:1px solid black; background-color:LightGreen; width:25px; height: 20px;"  align="center"></th>
                                <td   align="center">Rest Day</td>
                            </tr>
                            <tr style="height: 20px;">
                                <th style="border:1px solid black; background-color:#C4A484;  width:25px; height: 20px;" align="center"></th>
                                <td  align="center">Gazetted Day</td>
                            </tr>
                         </table>
                      </div>
                        <div class="text-center">
                          <h2>
                            Attendance Sheet
                          </h2>
                        </div>
                        <table class="table" style="table-layout: fixed">
                            <tr>
                                <th>Client</th>
                                <td><span t-esc="project.ora_client_id.name" /></td>
                                <th>Project</th>
                                <td><span t-esc="project.name" /></td>
                            </tr>
                            <tr>
                                <th>Date From</th>
                                <td><span t-esc="date_from" /></td>
                                <th>Date To</th>
                                <td><span t-esc="date_to"  /></td>
                            </tr>
                        </table>

                        <div class="row justify-content-end">
                            <div class="col-12">
                                <table class="table table-condensed"  style='font-size:13px;'>
                                    <thead>
                                        <tr>
                                            <th style="border: 1px solid black;">Employee</th>
                                            <th style="border: 1px solid black;">Remarks</th>
                                            <t t-set="todays" t-value="0"/>
                                            <t t-set="todays" t-value="days"/>
                                            <t t-set="datelabel" t-value="[]"/>
                                                <t t-foreach="todays" t-as="t">
                                                    <t t-set="datelabel" t-value="datelabel+[t]"/>
                                            </t>
                                            <t t-foreach="set(datelabel)" t-as="ta">
                                                <t t-if="datelabel">
                                                  <th style="border: 1px solid black;">
                                                      <span t-esc="(docs_date_from + datetime.timedelta(ta)).strftime('%b')"/>
                                                      <span t-esc="(docs_date_from + datetime.timedelta(ta)).strftime('%d')"/>
                                                  </th>
                                                </t>
                                            </t>
                                            <th style="border: 1px solid black;">Working Days</th>
                                            <th style="border: 1px solid black;">Extra Days</th>
                                            <th style="border: 1px solid black;">OT Hours</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                      <t t-set="tot_line_total" t-value="0"/>  
                                      <t t-set="tot_extra_days_total" t-value="0"/>  
                                      <t t-set="tot_ot_total" t-value="0"/>  
                                      <t t-foreach="employees" t-as="line">
                                        <tr>
                                            <td style="border: 1px solid black;">
                                                <span t-field="line.employee_id.name" /><br/>(<span t-field="line.employee_id.emp_number" />)
                                            </td>
                                            <td style="border: 1px solid black;">
                                                
                                                Attendance
                                                <hr/>
                                                Overtime
                                            </td>
                                            
                                            
                                             <t t-foreach="request.env['hr.timesheet.report.line'].sudo().search([('employee_id','=',line.employee_id.id),('project_id','=',project.id),('date_from','&gt;=', start_date_from),('date_to','&lt;=', start_date_from)], limit=1)" t-as="sheet_line"> 
                                                 <t t-set="startday" t-value="(sheet_line.date_from).strftime('%d')"/>
                                                 <t t-set="start_date" t-value="sheet_line.date_from"/>
                                             </t>
                                            
                                             <t t-set="docs_start_date" t-value="docs_date_from"/>
                                              <t t-set="line_total" t-value="0"/>
                                              <t t-set="extra_days_total" t-value="0"/>
                                              <t t-set="ot_total" t-value="0"/>
                                              <t t-foreach="set(datelabel)" t-as="lineta">
                                                <t t-if="datelabel">
                                                    <t t-set="var_rest_day" t-value="0"/>
                                                    <t t-set="var_gazetted_day" t-value="0"/>
                                                    <t t-set="var_shift_day" t-value="request.env['resource.calendar'].sudo().search([('company_id','=',line.employee_id.company_id.id),('shift_type','=','general')], limit=1).id"/>
                                                    <t t-foreach="request.env['hr.shift.schedule.line'].sudo().search([('employee_id','=',line.employee_id.id),('date','=',docs_start_date),('rest_day','=',True)], limit=1)" t-as="rest_day">
                                                        <t t-set="var_rest_day" t-value="1"/>
                                                    </t> 
                                                    <t t-foreach="request.env['hr.shift.schedule.line'].sudo().search([('employee_id','=',line.employee_id.id),('date','=',docs_start_date)], limit=1)" t-as="nrest_day">
                                                      <t t-set="var_shift_day" t-value="nrest_day.first_shift_id.id"/>
                                                    </t>
                                                    
                                                    <t t-foreach="request.env['shift.gazetted.line'].sudo().search([('shift_id','=',var_shift_day),('date','=',docs_start_date)])" t-as="gazetted_day">

                                                         <t t-set="var_gazetted_day" t-value="1"/>
                                                    </t>
                                                    
                                                    <t t-set="docs_start_date" t-value="docs_start_date + datetime.timedelta(1)"/>
                                                        <t t-if="var_rest_day==1" >
                                                            <td style="border: 1px solid black;background-color:LightGreen;">
                                                             <t t-if="(docs_date_from + datetime.timedelta(lineta)).strftime('%d')==startday" >
                                                                <t t-foreach="request.env['hr.attendance'].search([('employee_id','=',line.employee_id.id),('att_date','=',start_date),('check_in','!=',False),('check_out','!=',False)], limit=1)" t-as="attr">
                                                                    <t t-if='attr.worked_hours > (attr.shift_id.hours_per_day/2)' >  
                                                                      P
                                                                    
                                                                 <hr/>
                                                                 <t t-set="rest_ovt_hours" t-value="(attr.worked_hours - attr.shift_id.hours_per_day)"/>   
                                                                 <t t-if='rest_ovt_hours > 1'>   
                                                                    <span t-esc='round(rest_ovt_hours,2)'/>
                                                                    <t t-set="ot_total" t-value="ot_total + round(rest_ovt_hours,2)"/>
 
                                                                 </t>  
                                                                    
                                                                <t t-set="extra_days_total" t-value="extra_days_total + 1"/>
                                                                </t>
                                                                </t>    
                                                                <t t-set="start_date" t-value="start_date + datetime.timedelta(1)"/>
                                                                <t t-set="startday" t-value="(start_date).strftime('%d')"/>
                                                               </t>
                                                            
                                                            </td>
                                                        </t>

                                                        <t t-if="var_gazetted_day==1" >
                                                         <t t-if="not var_rest_day ==1" >
                                                            <td style="border: 1px solid black;background-color:#C4A484;">
                                                              <t t-if="(docs_date_from + datetime.timedelta(lineta)).strftime('%d')==startday" >                                                       
                                                                <t t-foreach="request.env['hr.attendance'].search([('employee_id','=',line.employee_id.id),('att_date','=',start_date),('check_in','!=',False),('check_out','!=',False)], limit=1)" t-as="att">
                                                                <t t-if='att.worked_hours > (att.shift_id.hours_per_day/2)' >      
                                                                      P
                                                                 <hr/>
                                                                 <t t-set="gazetted_ovt_hours" t-value="(att.worked_hours - att.shift_id.hours_per_day)"/>   
                                                                 <t t-if='gazetted_ovt_hours > 1'>   
                                                                    <span t-esc='round(gazetted_ovt_hours,2)'/>
                                                                                                                                                                                         <t t-set="ot_total" t-value="ot_total + round(gazetted_ovt_hours,2)"/>
 
                                                                 </t>   
                                                                <t t-set="extra_days_total" t-value="extra_days_total + 1"/>
                                                                </t>
                                                                </t>    
                                                                <t t-set="start_date" t-value="start_date + datetime.timedelta(1)"/>
                                                                <t t-set="startday" t-value="(start_date).strftime('%d')"/>
                                                                </t>
                                                              
                                                            </td>
                                                          </t>
                                                        </t>

                                                        <t t-if="not var_gazetted_day==1" >
                                                         <t t-if="not var_rest_day ==1" >
                                                            <td style="border: 1px solid black;">
                                                              <t t-if="(docs_date_from + datetime.timedelta(lineta)).strftime('%d')==startday" >                                                                                                      
                                                                <t t-foreach="request.env['hr.attendance'].search([('employee_id','=',line.employee_id.id),('att_date','=',start_date),('check_in','!=',False),('check_out','!=',False)], limit=1)" t-as="att">
                                                                 <t t-if='att.worked_hours > (att.shift_id.hours_per_day/2)' >  
                                                                  P    
                                                                 <hr/>
                                                                 <t t-set="normal_ovt_hours" t-value="(att.worked_hours - att.shift_id.hours_per_day)"/>   
                                                                 <t t-if='normal_ovt_hours > 1'>   
                                                                    <span t-esc='round(normal_ovt_hours,2)'/>
                                                                    <t t-set="ot_total" t-value="ot_total + round(normal_ovt_hours,2)"/> 
                                                                 </t> 
                                                                     
                                                                 <t t-set="line_total" t-value="line_total + 1"/>
                                                                  </t>    
                                                                </t>
                                                                <t t-set="start_date" t-value="start_date + datetime.timedelta(1)"/>
                                                                <t t-set="startday" t-value="(start_date).strftime('%d')"/>
                                                                 </t> 
                                                             
                                                            </td>
                                                          </t>
                                                        </t>
                                                  </t>
                                                </t>

                                             <td style="border: 1px solid black;">  
                                                  <span t-esc="round(line_total,2)"/>
                                                  <t t-set="tot_line_total" t-value="tot_line_total + line_total"/>      
                                              </td>
                                            <td style="border: 1px solid black;">  
                                                  <span t-esc="round(extra_days_total,2)"/>
                                                  <t t-set="tot_extra_days_total" t-value="tot_extra_days_total + extra_days_total"/>      

                                              </td>
                                            <td style="border: 1px solid black;">
                                                  <hr/>
                                                  <span t-esc="round(ot_total,2)"/>
                                                  <t t-set="tot_ot_total" t-value="tot_ot_total + ot_total"/>       
                                              </td>
                                        </tr>
                                      </t>
                                        <tr>
                                            <td></td>
                                            <td></td>
                                            <t t-foreach="set(datelabel)" t-as="tot">  
                                              <td></td>
                                            </t>
                                            
                                            <td ><span t-esc="round(tot_line_total,2)"/> Days</td> 
                                            <td ><span t-esc="round(tot_extra_days_total,2)"/> Days</td> 
                                            <td ><span t-esc="round(tot_ot_total,2)"/> Hours</td> 
                                        </tr>

                                    </tbody>
                                </table>
                                <br/>
                               <table class="table" style="table-layout: fixed">
                                        <tr>
                                            <th colspan="4"> <span t-esc="timesheet_report.incharge_id.company_id.name"/></th>
                                            <th >Approved By</th>
                                        </tr>
                                        <tr>
                                            <th>Name</th>
                                            <td><u><span t-esc="timesheet_report.incharge_id.name"/></u></td>
                                            <th>Signature</th>
                                            <td>------------</td>
                                            <th>Name</th>
                                            <td><u>
                                                <t t-if='timesheet_report.state=="approved"'>
                                                   <span t-esc="timesheet_report.incharge_id.parent_id.name"/>
                                                </t> 
                                                </u></td>

                                            <th>Signature</th>
                                            <td>------------</td>

                                        </tr>
                                        <tr>

                                            <th>Position</th>
                                            <td><u>
                                                
                                                  <span t-esc="timesheet_report.incharge_id.job_id.name"/>
                                                   
                                                </u>
                                            
                                            </td>
                                            <th>Date</th>
                                            <td>-----------</td>
                                            <th>Position</th>
                                            <td><u>
                                                <t t-if='timesheet_report.state=="approved"'>
                                                <span t-esc="timesheet_report.incharge_id.parent_id.job_id.name"/>
                                                </t>    
                                                </u></td>
                                            <th>Date</th>
                                            <td>-----------</td>
                                        </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </t>
            </t>
        
    </template>

</odoo>